<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Outreach Tracker</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700&family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        .safe-mode *,
.safe-mode *::before,
.safe-mode *::after {
    animation: none !important;
    transition: none !important;
    transform: none !important;
    filter: none !important;
    backdrop-filter: none !important;
    box-shadow: none !important;
    text-shadow: none !important;
}

:root {
            --primary: #355C7D;
            --primary-light: #4a7a9e;
            --primary-dark: #2a4a66;
            --primary-glow: rgba(53, 92, 125, 0.3);
            --accent: #F67280;
            --accent-warm: #F8B595;
            --accent-coral: #C06C84;
            --surface-0: #0a0f14;
            --surface-1: #111921;
            --surface-2: #182029;
            --surface-3: #1f2936;
            --surface-4: #2a3544;
            --border: rgba(53, 92, 125, 0.25);
            --border-subtle: rgba(255, 255, 255, 0.06);
            --text-primary: #f0f4f8;
            --text-secondary: #8fa3b8;
            --text-muted: #5a6f82;
            --success: #6EE7B7;
            --success-muted: #34D399;
            --warning: #FCD34D;
            --danger: #F87171;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--surface-0);
            background-image:
                radial-gradient(ellipse 80% 50% at 50% -20%, rgba(53, 92, 125, 0.15), transparent),
                radial-gradient(ellipse 60% 40% at 100% 100%, rgba(198, 108, 132, 0.08), transparent);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.5;
        }

        .container {
            max-width: 1440px;
            margin: 0 auto;
            padding: 32px;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
        }

        h1 {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 28px;
            font-weight: 600;
            letter-spacing: -0.5px;
            background: linear-gradient(135deg, var(--text-primary) 0%, var(--primary-light) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .btn {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            cursor: pointer;
            font-family: 'DM Sans', sans-serif;
            font-size: 14px;
            font-weight: 600;
            letter-spacing: 0.3px;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 8px rgba(53, 92, 125, 0.25), inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(53, 92, 125, 0.35), inset 0 1px 0 rgba(255, 255, 255, 0.15);
        }
        .btn-secondary {
            background: var(--surface-3);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.05);
        }
        .btn-secondary:hover {
            background: var(--surface-4);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.08);
        }
        .btn-danger {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
        }
        .btn-danger:hover {
            box-shadow: 0 6px 20px rgba(220, 38, 38, 0.35);
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 16px;
            margin-bottom: 36px;
        }

        .stat-card {
            background: linear-gradient(145deg, var(--surface-1) 0%, var(--surface-2) 100%);
            border: 1px solid var(--border-subtle);
            border-radius: 16px;
            padding: 20px;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, transparent, var(--primary), transparent);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .stat-card:hover::before {
            opacity: 1;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            border-color: var(--border);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
        }

        .stat-label {
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1.2px;
            font-weight: 500;
        }

        .stat-value {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 36px;
            font-weight: 700;
            margin-top: 8px;
            letter-spacing: -1px;
        }

        .stat-value.blue { color: var(--primary-light); }
        .stat-value.yellow { color: var(--warning); }
        .stat-value.purple { color: var(--accent-coral); }
        .stat-value.green { color: var(--success); }
        .stat-value.red { color: var(--danger); }

        .pipeline {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 14px;
            margin-bottom: 36px;
        }

        @media (max-width: 1200px) { .pipeline { grid-template-columns: repeat(3, 1fr); } }
        @media (max-width: 768px) { .pipeline { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 600px) { .pipeline { grid-template-columns: 1fr; } }

        .column {
            background: var(--surface-1);
            border: 1px solid var(--border-subtle);
            border-radius: 16px;
            min-height: 420px;
            overflow: hidden;
        }

        .column-header {
            padding: 16px 18px;
            border-bottom: 1px solid var(--border-subtle);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(180deg, rgba(255,255,255,0.02) 0%, transparent 100%);
        }

        .column-title {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-secondary);
        }

        .column-count {
            background: var(--surface-3);
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .column-body {
            padding: 14px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .prospect-card {
            background: var(--surface-2);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            padding: 14px;
            cursor: pointer;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        .prospect-card:hover {
            border-color: var(--border);
            transform: translateY(-3px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.25);
        }

        .prospect-name {
            font-weight: 600;
            margin-bottom: 6px;
            color: var(--text-primary);
        }
        .prospect-company {
            font-size: 13px;
            color: var(--text-muted);
        }
        .prospect-followup {
            font-size: 11px;
            color: var(--accent-warm);
            margin-top: 10px;
            font-weight: 500;
        }
        .prospect-followup.overdue { color: var(--danger); }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(10, 15, 20, 0.92);
            z-index: 100;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active { display: flex; }

        .modal {
            background: var(--surface-1);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 28px;
            width: 100%;
            max-width: 520px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 24px 80px rgba(0, 0, 0, 0.5);
        }

        .modal h2 {
            margin-bottom: 24px;
            font-family: 'Space Grotesk', sans-serif;
            font-weight: 600;
            letter-spacing: -0.3px;
        }
        .form-group { margin-bottom: 18px; }
        .form-group label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.8px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 16px;
            background: var(--surface-2);
            border: 1px solid var(--border-subtle);
            border-radius: 10px;
            color: var(--text-primary);
            font-family: 'DM Sans', sans-serif;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-glow);
        }

        .form-group textarea { min-height: 80px; resize: vertical; }
        .form-actions { display: flex; gap: 12px; margin-top: 28px; }
        .form-actions .btn { flex: 1; }

        .status-new { border-left: 4px solid var(--text-muted); }
        .status-contacted { border-left: 4px solid var(--primary-light); }
        .status-responded { border-left: 4px solid var(--accent-coral); }
        .status-call_scheduled { border-left: 4px solid var(--warning); }
        .status-closed { border-left: 4px solid var(--success); }
        .status-pilot { border-left: 4px solid #22c55e; }
        .status-client { border-left: 4px solid var(--success-muted); }
        .status-lost { border-left: 4px solid var(--danger); }

        .quick-actions { display: flex; gap: 6px; margin-top: 10px; flex-wrap: wrap; }
        .quick-btn {
            font-size: 10px;
            padding: 5px 10px;
            background: var(--surface-3);
            border: none;
            border-radius: 6px;
            color: var(--text-muted);
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        .quick-btn:hover {
            background: var(--primary);
            color: white;
        }

        .empty-state { text-align: center; padding: 48px 24px; color: var(--text-muted); }
        .empty-state p { margin-bottom: 16px; }

        .goal-section {
            background: linear-gradient(145deg, var(--surface-1) 0%, var(--surface-2) 100%);
            border: 1px solid var(--border-subtle);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 28px;
        }

        .goal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 14px;
        }

        .goal-progress {
            height: 10px;
            background: var(--surface-3);
            border-radius: 10px;
            overflow: hidden;
        }

        .goal-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary) 0%, var(--success) 100%);
            transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 10px;
        }

        .goal-text { font-size: 13px; color: var(--text-muted); margin-top: 10px; }

        .prospect-card.dragging { opacity: 0.5; transform: rotate(3deg) scale(1.02); }
        .column-body.drag-over {
            background: var(--primary-glow);
            border: 2px dashed var(--primary);
            border-radius: 12px;
        }
        .prospect-card[draggable="true"] { cursor: grab; }
        .prospect-card[draggable="true"]:active { cursor: grabbing; }

        .header-actions { display: flex; gap: 14px; align-items: center; }
        .view-toggle {
            display: flex;
            background: var(--surface-2);
            border-radius: 10px;
            padding: 4px;
            border: 1px solid var(--border-subtle);
        }
        .view-toggle button {
            background: transparent;
            border: none;
            color: var(--text-muted);
            padding: 8px 16px;
            border-radius: 7px;
            cursor: pointer;
            font-family: 'DM Sans', sans-serif;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        .view-toggle button:hover { color: var(--text-primary); }
        .view-toggle button.active {
            background: var(--primary);
            color: white;
            box-shadow: 0 2px 8px rgba(53, 92, 125, 0.3);
        }

        .list-view { display: none; }
        .list-view.active { display: block; }
        .pipeline.hidden { display: none; }

        .prospects-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--surface-1);
            border-radius: 16px;
            overflow: hidden;
        }

        .prospects-table th,
        .prospects-table td {
            padding: 14px 18px;
            text-align: left;
            border-bottom: 1px solid var(--border-subtle);
        }

        .prospects-table th {
            background: var(--surface-2);
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-muted);
        }

        .prospects-table tr:hover { background: var(--surface-2); cursor: pointer; }
        .prospects-table tr:last-child td { border-bottom: none; }

        .status-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 6px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-badge.new { background: var(--surface-3); color: var(--text-muted); }
        .status-badge.contacted { background: rgba(53, 92, 125, 0.2); color: var(--primary-light); }
        .status-badge.responded { background: rgba(192, 108, 132, 0.2); color: var(--accent-coral); }
        .status-badge.call_scheduled { background: rgba(252, 211, 77, 0.15); color: var(--warning); }
        .status-badge.closed { background: rgba(110, 231, 183, 0.15); color: var(--success); }
        .status-badge.pilot { background: rgba(34, 197, 94, 0.16); color: #22c55e; }
        .status-badge.client { background: rgba(52, 211, 153, 0.15); color: var(--success-muted); }
        .status-badge.lost { background: rgba(248, 113, 113, 0.15); color: var(--danger); }

        .table-empty { text-align: center; padding: 48px; color: var(--text-muted); }

        /* Daily Tasks */
        .daily-tasks {
            background: linear-gradient(145deg, var(--surface-1) 0%, var(--surface-2) 100%);
            border: 1px solid var(--border-subtle);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 28px;
        }

        .daily-tasks-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 18px;
        }

        .daily-tasks-title {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-secondary);
        }

        .daily-tasks-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .daily-task {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 14px 18px;
            background: var(--surface-2);
            border-radius: 12px;
            border: 1px solid var(--border-subtle);
            transition: all 0.2s ease;
        }

        .daily-task:hover {
            border-color: var(--border);
        }

        .daily-task.completed {
            background: rgba(110, 231, 183, 0.08);
            border-color: rgba(110, 231, 183, 0.2);
        }

        .daily-task-checkbox {
            width: 26px;
            height: 26px;
            border: 2px solid var(--surface-4);
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.25s ease;
            flex-shrink: 0;
        }

        .daily-task-checkbox:hover {
            border-color: var(--success);
            box-shadow: 0 0 0 4px rgba(110, 231, 183, 0.15);
        }

        .daily-task.completed .daily-task-checkbox {
            background: var(--success);
            border-color: var(--success);
        }

        .daily-task-checkbox::after {
            content: '';
            width: 10px;
            height: 10px;
            background: transparent;
        }

        .daily-task.completed .daily-task-checkbox::after {
            content: '\2713';
            color: var(--surface-0);
            font-weight: bold;
            font-size: 14px;
        }

        .daily-task-input {
            flex: 1;
            background: transparent;
            border: none;
            color: var(--text-primary);
            font-family: 'DM Sans', sans-serif;
            font-size: 15px;
            outline: none;
        }

        .daily-task-input::placeholder {
            color: var(--text-muted);
        }

        .daily-task.completed .daily-task-input {
            text-decoration: line-through;
            color: var(--success);
        }

        .daily-task-delete {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 6px;
            opacity: 0;
            transition: all 0.2s ease;
            border-radius: 6px;
        }

        .daily-task:hover .daily-task-delete {
            opacity: 1;
        }

        .daily-task-delete:hover {
            color: var(--danger);
            background: rgba(248, 113, 113, 0.1);
        }

        .add-task-btn {
            background: transparent;
            border: 2px dashed var(--surface-4);
            color: var(--text-muted);
            padding: 14px 18px;
            border-radius: 12px;
            cursor: pointer;
            font-family: 'DM Sans', sans-serif;
            font-size: 14px;
            font-weight: 500;
            width: 100%;
            transition: all 0.2s ease;
        }

        .add-task-btn:hover {
            border-color: var(--primary);
            color: var(--primary-light);
            background: var(--primary-glow);
        }

        /* Weekly Readings */
        .readings-indicator {
            margin-bottom: 28px;
        }

        .readings-header {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 18px;
            background: var(--surface-1);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .readings-header:hover {
            border-color: var(--border);
        }

        .readings-header.expanded {
            border-radius: 12px 12px 0 0;
            border-bottom-color: transparent;
        }

        .readings-toggle {
            color: var(--text-muted);
            font-size: 10px;
            transition: transform 0.25s ease;
        }

        .readings-header.expanded .readings-toggle {
            transform: rotate(90deg);
        }

        .readings-week {
            font-size: 12px;
            color: var(--text-muted);
            font-weight: 500;
        }

        .readings-count {
            font-size: 12px;
            color: var(--text-muted);
            margin-left: auto;
        }

        .readings-progress {
            color: var(--success);
        }

        .readings-list {
            display: none;
            background: var(--surface-1);
            border: 1px solid var(--border-subtle);
            border-top: none;
            border-radius: 0 0 12px 12px;
            padding: 14px 18px;
        }

        .readings-list.expanded {
            display: block;
        }

        .reading-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 10px 0;
            border-bottom: 1px solid var(--surface-3);
        }

        .reading-item:last-child {
            border-bottom: none;
        }

        .reading-checkbox {
            width: 18px;
            height: 18px;
            border: 2px solid var(--surface-4);
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            margin-top: 2px;
            transition: all 0.2s ease;
        }

        .reading-checkbox:hover {
            border-color: var(--success);
        }

        .reading-checkbox.checked {
            background: var(--success);
            border-color: var(--success);
        }

        .reading-checkbox.checked::after {
            content: '\2713';
            color: var(--surface-0);
            font-size: 11px;
            font-weight: bold;
        }

        .reading-item.completed .reading-text {
            text-decoration: line-through;
            color: var(--text-muted);
        }

        .reading-text {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .reading-note {
            font-size: 11px;
            color: var(--text-muted);
            font-style: italic;
            margin-top: 4px;
        }

        /* Celebration overlay */
        .celebration {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(10, 15, 20, 0.95);
            backdrop-filter: blur(12px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 200;
            flex-direction: column;
        }

        .celebration.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .celebration-content {
            text-align: center;
            animation: scaleIn 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        @keyframes scaleIn {
            from { transform: scale(0.5); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .celebration-emoji {
            font-size: 120px;
            margin-bottom: 24px;
            animation: bounce 0.6s ease infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }

        .celebration-title {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 52px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--success) 0%, var(--primary-light) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 12px;
            letter-spacing: -1px;
        }

        .celebration-subtitle {
            font-size: 20px;
            color: var(--text-secondary);
            margin-bottom: 36px;
        }

        .celebration-btn {
            background: linear-gradient(135deg, var(--success) 0%, var(--success-muted) 100%);
            color: var(--surface-0);
            border: none;
            padding: 18px 52px;
            border-radius: 12px;
            font-family: 'DM Sans', sans-serif;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.25s ease;
            box-shadow: 0 4px 20px rgba(110, 231, 183, 0.3);
        }

        .celebration-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(110, 231, 183, 0.4);
        }

        /* Confetti */
        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            animation: confetti-fall 3s ease-out forwards;
        }

        @keyframes confetti-fall {
            0% { transform: translateY(-100vh) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }

        /* One Thing */
        .one-thing {
            background: linear-gradient(145deg, var(--surface-1) 0%, var(--surface-2) 100%);
            border: 2px solid var(--border);
            border-radius: 20px;
            padding: 32px;
            margin-bottom: 28px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .one-thing::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--accent-coral), var(--accent));
        }

        .one-thing-label {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 3px;
            color: var(--text-muted);
            margin-bottom: 16px;
            font-weight: 600;
        }

        .one-thing-input {
            width: 100%;
            background: transparent;
            border: none;
            color: var(--text-primary);
            font-family: 'Space Grotesk', sans-serif;
            font-size: 28px;
            font-weight: 600;
            text-align: center;
            outline: none;
            letter-spacing: -0.5px;
        }

        .one-thing-input::placeholder {
            color: var(--surface-4);
        }

        .one-thing-input:focus {
            color: var(--primary-light);
        }

        /* Floating Goal Window */
        .goal-float {
            position: fixed;
            top: 24px;
            right: 24px;
            background: rgba(17, 25, 33, 0.95);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 20px 24px;
            z-index: 1000;
            cursor: move;
            user-select: none;
            backdrop-filter: blur(16px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
            min-width: 220px;
            transition: all 0.3s ease;
        }

        .goal-float:hover {
            border-color: var(--primary);
            box-shadow: 0 16px 50px rgba(0, 0, 0, 0.5), 0 0 30px var(--primary-glow);
        }

        .goal-float-amount {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 26px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--success) 0%, var(--primary-light) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-align: center;
            letter-spacing: -0.5px;
        }

        .goal-float-why {
            font-size: 12px;
            color: var(--text-muted);
            text-align: center;
            margin-top: 6px;
        }

        .goal-float-why strong {
            color: var(--text-secondary);
        }

        .goal-float-handle {
            position: absolute;
            top: 8px;
            left: 50%;
            transform: translateX(-50%);
            width: 36px;
            height: 4px;
            background: var(--surface-4);
            border-radius: 4px;
        }

        /* Day Toggle */
        .day-toggle-container {
            display: flex;
            justify-content: center;
            margin-bottom: 24px;
        }

        .day-toggle {
            display: flex;
            background: var(--surface-2);
            border-radius: 12px;
            padding: 5px;
            border: 1px solid var(--border-subtle);
        }

        .day-toggle button {
            background: transparent;
            border: none;
            color: var(--text-muted);
            padding: 12px 28px;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'DM Sans', sans-serif;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.25s ease;
        }

        .day-toggle button:hover {
            color: var(--text-primary);
        }

        .day-toggle button.active {
            background: var(--primary);
            color: white;
            box-shadow: 0 2px 8px rgba(53, 92, 125, 0.3);
        }

        .day-toggle button.tomorrow.active {
            background: linear-gradient(135deg, var(--accent-coral) 0%, var(--accent) 100%);
            box-shadow: 0 2px 8px rgba(246, 114, 128, 0.3);
        }

        .planning-mode-banner {
            display: none;
            background: linear-gradient(135deg, var(--accent-coral) 0%, var(--accent) 100%);
            color: white;
            text-align: center;
            padding: 12px 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            font-size: 13px;
            font-weight: 500;
            box-shadow: 0 4px 16px rgba(246, 114, 128, 0.25);
        }

        .planning-mode-banner.active {
            display: block;
        }

        /* Task History Panel */
        .history-btn {
            background: var(--surface-2);
            border: 1px solid var(--border-subtle);
            color: var(--text-muted);
            padding: 10px 18px;
            border-radius: 10px;
            cursor: pointer;
            font-family: 'DM Sans', sans-serif;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.25s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .history-btn:hover {
            background: var(--surface-3);
            color: var(--text-primary);
            border-color: var(--border);
        }

        .history-btn svg {
            width: 16px;
            height: 16px;
        }

        .history-panel {
            position: fixed;
            top: 0;
            right: -500px;
            width: 500px;
            height: 100vh;
            background: var(--surface-0);
            border-left: 1px solid var(--border);
            z-index: 150;
            transition: right 0.35s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
            box-shadow: -16px 0 48px rgba(0, 0, 0, 0.5);
        }

        .history-panel.active {
            right: 0;
        }

        .history-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(10, 15, 20, 0.6);
            backdrop-filter: blur(4px);
            z-index: 140;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .history-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .history-header {
            padding: 24px 28px;
            border-bottom: 1px solid var(--border-subtle);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .history-title {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 20px;
            font-weight: 600;
            letter-spacing: -0.3px;
        }

        .history-close {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 10px;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .history-close:hover {
            background: var(--surface-2);
            color: var(--text-primary);
        }

        .history-filters {
            padding: 18px 28px;
            border-bottom: 1px solid var(--border-subtle);
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .history-filter {
            background: var(--surface-2);
            border: 1px solid var(--border-subtle);
            color: var(--text-muted);
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-family: 'DM Sans', sans-serif;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .history-filter:hover {
            border-color: var(--border);
            color: var(--text-primary);
        }

        .history-filter.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        .history-filter.completed.active {
            background: var(--success);
            border-color: var(--success);
            color: var(--surface-0);
        }

        .history-stats {
            padding: 18px 28px;
            background: var(--surface-1);
            display: flex;
            gap: 28px;
        }

        .history-stat {
            text-align: center;
        }

        .history-stat-value {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 26px;
            font-weight: 700;
        }

        .history-stat-value.green { color: var(--success); }
        .history-stat-value.blue { color: var(--primary-light); }
        .history-stat-value.yellow { color: var(--warning); }

        .history-stat-label {
            font-size: 10px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 500;
        }

        .history-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px 28px;
        }

        .history-date-group {
            margin-bottom: 28px;
        }

        .history-date {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 14px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--surface-2);
        }

        .history-task {
            display: flex;
            align-items: flex-start;
            gap: 14px;
            padding: 14px 18px;
            background: var(--surface-1);
            border-radius: 12px;
            margin-bottom: 10px;
            transition: all 0.2s ease;
            border: 1px solid transparent;
        }

        .history-task:hover {
            background: var(--surface-2);
            border-color: var(--border-subtle);
        }

        .history-task-status {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 2px;
        }

        .history-task-status.completed {
            background: var(--success);
        }

        .history-task-status.completed::after {
            content: '\2713';
            color: var(--surface-0);
            font-size: 12px;
            font-weight: bold;
        }

        .history-task-status.pending {
            background: var(--surface-3);
            border: 2px solid var(--surface-4);
        }

        .history-task-text {
            flex: 1;
            line-height: 1.6;
        }

        .history-task.is-completed .history-task-text {
            color: var(--text-muted);
            text-decoration: line-through;
        }

        .history-task-meta {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 6px;
        }

        .history-task-delete {
            background: transparent;
            border: 1px solid var(--border-subtle);
            color: var(--text-muted);
            border-radius: 8px;
            padding: 6px 10px;
            font-family: 'DM Sans', sans-serif;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .history-task-delete:hover {
            border-color: var(--danger);
            color: var(--danger);
            background: rgba(248, 113, 113, 0.1);
        }

        .history-empty {
            text-align: center;
            padding: 64px 24px;
            color: var(--text-muted);
        }

        .history-empty-icon {
            font-size: 52px;
            margin-bottom: 18px;
            opacity: 0.4;
        }

        .history-loading {
            text-align: center;
            padding: 44px;
            color: var(--text-muted);
        }

        .history-load-more {
            width: 100%;
            margin: 18px 0 36px;
            padding: 14px 18px;
            background: var(--surface-2);
            border: 1px solid var(--border-subtle);
            color: var(--text-primary);
            border-radius: 12px;
            cursor: pointer;
            font-family: 'DM Sans', sans-serif;
            font-size: 13px;
            font-weight: 500;
            letter-spacing: 0.02em;
            transition: all 0.25s ease;
        }

        .history-load-more:hover {
            border-color: var(--primary);
            background: var(--primary-glow);
            color: var(--primary-light);
        }

        @media (max-width: 520px) {
            .history-panel {
                width: 100%;
                right: -100%;
            }
        }

        /* Comprehensive Mobile Styles */
        @media (max-width: 600px) {
            /* Container and spacing */
            .container {
                padding: 20px 16px;
            }

            /* Header - stack on very small screens */
            header {
                flex-direction: column;
                align-items: flex-start;
                gap: 14px;
                margin-bottom: 20px;
            }

            h1 {
                font-size: 22px;
            }

            .header-actions {
                width: 100%;
                flex-wrap: wrap;
                gap: 10px;
            }

            .header-actions button,
            .header-actions .view-toggle,
            .header-actions .btn {
                font-size: 13px;
            }

            /* Make buttons more touch-friendly */
            .btn {
                padding: 12px 18px;
                min-height: 46px;
                white-space: nowrap;
            }

            .unmatched-calls-btn {
                font-size: 12px;
                padding: 10px 14px;
            }

            .history-btn {
                padding: 10px 14px;
            }

            .view-toggle button {
                padding: 10px 14px;
                font-size: 12px;
            }

            /* Stats grid - smaller min-width */
            .stats {
                grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
                gap: 12px;
                margin-bottom: 24px;
            }

            .stat-card {
                padding: 16px;
            }

            .stat-value {
                font-size: 28px;
            }

            .stat-label {
                font-size: 10px;
            }

            /* One Thing - smaller font */
            .one-thing {
                padding: 20px;
                margin-bottom: 20px;
            }

            .one-thing-input {
                font-size: 20px;
            }

            /* Daily tasks */
            .daily-tasks {
                padding: 18px;
                margin-bottom: 20px;
            }

            /* Goal section */
            .goal-section {
                padding: 16px;
                margin-bottom: 20px;
            }

            /* Pipeline - already single column from earlier rule */
            .pipeline {
                gap: 10px;
                margin-bottom: 24px;
            }

            /* Prospect cards - prevent text overflow */
            .prospect-card {
                padding: 12px;
            }

            .prospect-name {
                font-size: 14px;
                word-break: break-word;
                overflow-wrap: break-word;
            }

            .prospect-company {
                font-size: 12px;
                word-break: break-word;
                overflow-wrap: break-word;
            }

            .prospect-followup {
                font-size: 10px;
                margin-top: 8px;
            }

            .quick-actions {
                margin-top: 8px;
            }

            .quick-btn {
                font-size: 9px;
                padding: 5px 8px;
            }

            /* Column headers */
            .column-header {
                padding: 12px 14px;
            }

            .column-title {
                font-size: 11px;
            }

            .column-count {
                font-size: 11px;
                padding: 3px 8px;
            }

            .column-body {
                padding: 10px;
            }

            /* List view - add horizontal scroll */
            .list-view {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            .prospects-table {
                min-width: 600px;
            }

            .prospects-table th,
            .prospects-table td {
                padding: 12px 14px;
                font-size: 12px;
            }

            .prospects-table th {
                font-size: 10px;
            }

            /* Modal - full width on mobile */
            .modal {
                max-width: calc(100vw - 24px);
                padding: 22px 18px;
                margin: 12px;
                border-radius: 16px;
            }

            .modal h2 {
                font-size: 18px;
                margin-bottom: 18px;
            }

            .form-group {
                margin-bottom: 16px;
            }

            .form-group label {
                font-size: 11px;
            }

            .form-group input,
            .form-group select,
            .form-group textarea {
                padding: 12px;
                font-size: 14px;
            }

            .form-actions {
                flex-direction: column;
                gap: 10px;
            }

            .form-actions .btn {
                width: 100%;
            }

            /* Unmatched calls modal */
            .unmatched-modal {
                width: calc(100vw - 24px);
                max-width: calc(100vw - 24px);
                padding: 18px;
                max-height: 90vh;
                border-radius: 16px;
            }

            .unmatched-call-item {
                padding: 14px;
            }

            .unmatched-call-title {
                font-size: 13px;
                word-break: break-word;
            }

            .unmatched-call-date {
                font-size: 11px;
            }

            .unmatched-call-summary {
                font-size: 12px;
            }

            .unmatched-call-meta {
                flex-direction: column;
                align-items: flex-start;
                gap: 6px;
            }

            .unmatched-call-actions {
                gap: 8px;
                margin-top: 10px;
            }

            .unmatched-input {
                font-size: 13px;
                padding: 8px 12px;
            }

            .unmatched-action-btn {
                font-size: 12px;
                padding: 8px 14px;
            }

            /* Floating goal - adjust position */
            .goal-float {
                top: 12px;
                right: 12px;
                padding: 14px 18px;
                min-width: 170px;
            }

            .goal-float-amount {
                font-size: 20px;
            }

            .goal-float-why {
                font-size: 11px;
            }

            /* Day toggle */
            .day-toggle button {
                padding: 10px 18px;
                font-size: 13px;
            }

            /* Readings */
            .readings-header {
                padding: 10px 14px;
            }

            .readings-week {
                font-size: 11px;
            }

            .readings-count {
                font-size: 11px;
            }

            .reading-text {
                font-size: 12px;
            }

            /* Celebration - responsive text sizes */
            .celebration-emoji {
                font-size: 80px;
            }

            .celebration-title {
                font-size: 36px;
            }

            .celebration-subtitle {
                font-size: 16px;
            }

            .celebration-btn {
                padding: 14px 36px;
                font-size: 16px;
            }

            /* Call history in modal */
            .call-item {
                padding: 12px;
            }
        }

        /* Extra small screens */
        @media (max-width: 400px) {
            .container {
                padding: 16px 12px;
            }

            h1 {
                font-size: 20px;
            }

            .stats {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }

            .stat-value {
                font-size: 24px;
            }

            .one-thing-input {
                font-size: 18px;
            }

            .header-actions {
                gap: 8px;
            }

            .btn {
                padding: 10px 14px;
                font-size: 12px;
            }

            .prospect-name {
                font-size: 13px;
            }

            .prospect-company {
                font-size: 11px;
            }
        }

        /* Call History in Modal */
        .calls-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--border-subtle);
        }

        .calls-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 14px;
        }

        .calls-section-title {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.8px;
        }

        .calls-list {
            max-height: 320px;
            overflow-y: auto;
        }

        .call-item {
            background: var(--surface-2);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            padding: 14px;
            margin-bottom: 10px;
            transition: all 0.2s ease;
        }

        .call-item:hover {
            border-color: var(--border);
        }

        .call-date {
            font-size: 11px;
            color: var(--text-muted);
        }

        .call-title {
            font-weight: 600;
            margin: 6px 0;
            font-size: 14px;
        }

        .call-summary {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 10px;
            line-height: 1.5;
        }

        .call-link {
            display: inline-block;
            font-size: 12px;
            color: var(--primary-light);
            text-decoration: none;
            margin-bottom: 10px;
            font-weight: 500;
        }

        .call-link:hover {
            text-decoration: underline;
            color: var(--accent-warm);
        }

        .call-action-items {
            margin-top: 10px;
        }

        .call-action-items-title {
            font-size: 10px;
            color: var(--text-muted);
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            font-weight: 600;
        }

        .call-action-item {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 8px 0;
            font-size: 13px;
        }

        .call-action-item-text {
            flex: 1;
            color: var(--text-secondary);
        }

        .add-to-tasks-btn {
            font-size: 11px;
            padding: 4px 10px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            white-space: nowrap;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .add-to-tasks-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
        }

        .add-to-tasks-btn.added {
            background: var(--success);
            cursor: default;
        }

        .calls-empty {
            text-align: center;
            padding: 24px;
            color: var(--text-muted);
            font-size: 13px;
        }

        /* Unmatched Calls Indicator */
        .unmatched-calls-btn {
            background: rgba(252, 211, 77, 0.1);
            border: 1px solid var(--warning);
            color: var(--warning);
            padding: 8px 14px;
            border-radius: 10px;
            cursor: pointer;
            font-family: 'DM Sans', sans-serif;
            font-size: 12px;
            font-weight: 500;
            display: none;
            align-items: center;
            gap: 8px;
            transition: all 0.2s ease;
        }

        .unmatched-calls-btn.visible {
            display: flex;
        }

        .unmatched-calls-btn:hover {
            background: rgba(252, 211, 77, 0.15);
        }

        .unmatched-count-badge {
            background: var(--warning);
            color: var(--surface-0);
            padding: 2px 8px;
            border-radius: 12px;
            font-weight: 700;
            font-size: 11px;
        }

        .unmatched-overlay {
            position: fixed;
            inset: 0;
            background: rgba(10, 15, 20, 0.8);
            backdrop-filter: blur(6px);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.25s ease;
            z-index: 1000;
        }

        .unmatched-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }

        .unmatched-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: min(920px, 92vw);
            max-height: 80vh;
            background: var(--surface-1);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 24px;
            z-index: 1001;
            opacity: 0;
            pointer-events: none;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
            box-shadow: 0 24px 80px rgba(0, 0, 0, 0.5);
        }

        .unmatched-modal.active {
            opacity: 1;
            pointer-events: auto;
        }

        .unmatched-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .unmatched-title {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 18px;
            font-weight: 600;
            letter-spacing: -0.3px;
        }

        .unmatched-close {
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 24px;
            padding: 8px;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .unmatched-close:hover {
            background: var(--surface-2);
            color: var(--text-primary);
        }

        .unmatched-list {
            overflow-y: auto;
            max-height: 65vh;
            padding-right: 6px;
        }

        .unmatched-call-item {
            border: 1px solid var(--border-subtle);
            border-radius: 14px;
            padding: 18px;
            margin-bottom: 14px;
            background: var(--surface-2);
            transition: all 0.2s ease;
        }

        .unmatched-call-item:hover {
            border-color: var(--border);
        }

        .unmatched-call-meta {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            gap: 14px;
            margin-bottom: 10px;
        }

        .unmatched-call-title {
            font-weight: 600;
            font-size: 15px;
        }

        .unmatched-call-date {
            font-size: 12px;
            color: var(--text-muted);
        }

        .unmatched-call-summary {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 12px;
            line-height: 1.5;
        }

        .unmatched-call-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
        }

        .unmatched-input {
            background: var(--surface-0);
            border: 1px solid var(--border-subtle);
            color: var(--text-primary);
            border-radius: 8px;
            padding: 10px 12px;
            font-family: 'DM Sans', sans-serif;
            font-size: 13px;
            min-width: 200px;
            transition: all 0.2s ease;
        }

        .unmatched-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-glow);
        }

        .unmatched-action-btn {
            background: var(--primary);
            color: #fff;
            border: none;
            border-radius: 8px;
            padding: 10px 16px;
            font-family: 'DM Sans', sans-serif;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .unmatched-action-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(53, 92, 125, 0.3);
        }

        .unmatched-action-btn.danger {
            background: var(--danger);
        }

        .unmatched-action-btn.danger:hover {
            box-shadow: 0 4px 12px rgba(248, 113, 113, 0.3);
        }
    </style>
</head>
<body>
    <!-- Floating Goal Window -->
    <div class="goal-float" id="goalFloat">
        <div class="goal-float-handle"></div>
        <div class="goal-float-amount">5k  10k</div>
        <div class="goal-float-why">For <strong>Paula</strong> & the kids</div>
    </div>

    <div class="unmatched-overlay" id="unmatchedOverlay" onclick="closeUnmatchedCalls()"></div>
    <div class="unmatched-modal" id="unmatchedModal">
        <div class="unmatched-header">
            <div class="unmatched-title">Unmatched Calls</div>
            <button class="unmatched-close" onclick="closeUnmatchedCalls()"></button>
        </div>
        <div class="unmatched-list" id="unmatchedList">
            <!-- Rendered by JS -->
        </div>
    </div>

    <div class="container">
        <header>
            <h1>Outreach Tracker</h1>
            <div class="header-actions">
                <button class="unmatched-calls-btn" id="unmatchedCallsBtn" onclick="showUnmatchedCalls()">
                    <span class="unmatched-count-badge" id="unmatchedCount">0</span>
                    Unmatched Calls
                </button>
                <button class="history-btn" onclick="openHistory()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <polyline points="12 6 12 12 16 14"/>
                    </svg>
                    History
                </button>
                <div class="view-toggle">
                    <button id="btnPipeline" class="active" onclick="setView('pipeline')">Pipeline</button>
                    <button id="btnList" onclick="setView('list')">List</button>
                </div>
                <button class="btn" onclick="openModal()">+ Add Prospect</button>
            </div>
        </header>

        <!-- Day Toggle -->
        <div class="day-toggle-container">
            <div class="day-toggle">
                <button id="btnToday" class="active" onclick="setDayView('today')">Today</button>
                <button id="btnTomorrow" class="tomorrow" onclick="setDayView('tomorrow')">Tomorrow</button>
            </div>
        </div>

        <!-- Planning Mode Banner -->
        <div class="planning-mode-banner" id="planningBanner">
             Planning for Tomorrow - Changes will take effect tomorrow morning
        </div>

        <!-- One Thing -->
        <div class="one-thing">
            <div class="one-thing-label" id="oneThingLabel">The One Thing</div>
            <input type="text" class="one-thing-input" id="oneThingInput"
                placeholder="What matters most today?"
                onchange="saveOneThing(this.value)">
        </div>

        <!-- Daily Tasks -->
        <div class="daily-tasks">
            <div class="daily-tasks-header">
                <div class="daily-tasks-title" id="dailyTasksTitle">Today's Main Tasks</div>
            </div>
            <div class="daily-tasks-list" id="dailyTasksList">
                <!-- Tasks rendered by JS -->
            </div>
        </div>

        <!-- Weekly Readings Indicator -->
        <div class="readings-indicator" id="readingsIndicator">
            <div class="readings-header" id="readingsHeader" onclick="toggleReadings()">
                <span class="readings-toggle">&#9654;</span>
                <span class="readings-week" id="readingsWeek">Week 2</span>
                <span class="readings-count" id="readingsCount">2 essential readings</span>
            </div>
            <div class="readings-list" id="readingsList">
                <!-- Readings rendered by JS -->
            </div>
        </div>

        <div class="goal-section">
            <div class="goal-header">
                <span style="font-weight: 600;">Goal: Close 3-5 new clients</span>
                <span id="goalProgress">0 / 3 closed</span>
            </div>
            <div class="goal-progress">
                <div class="goal-progress-bar" id="goalProgressBar" style="width: 0%"></div>
            </div>
            <div class="goal-text" id="goalText">Add prospects and move them through your pipeline</div>
        </div>

        <div class="stats">
            <div class="stat-card">
                <div class="stat-label">Total Prospects</div>
                <div class="stat-value" id="statTotal">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Contacted</div>
                <div class="stat-value blue" id="statContacted">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Present</div>
                <div class="stat-value purple" id="statResponded">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Propose</div>
                <div class="stat-value yellow" id="statCalls">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Close</div>
                <div class="stat-value green" id="statClosed">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Progress Rate</div>
                <div class="stat-value" id="statResponseRate">0%</div>
            </div>
        </div>

        <div class="pipeline">
            <div class="column" data-status="new">
                <div class="column-header">
                    <span class="column-title">Target</span>
                    <span class="column-count" id="countNew">0</span>
                </div>
                <div class="column-body" id="colNew"></div>
            </div>
            <div class="column" data-status="contacted">
                <div class="column-header">
                    <span class="column-title">Contacted</span>
                    <span class="column-count" id="countContacted">0</span>
                </div>
                <div class="column-body" id="colContacted"></div>
            </div>
            <div class="column" data-status="responded">
                <div class="column-header">
                    <span class="column-title">Present</span>
                    <span class="column-count" id="countResponded">0</span>
                </div>
                <div class="column-body" id="colResponded"></div>
            </div>
            <div class="column" data-status="call_scheduled">
                <div class="column-header">
                    <span class="column-title">Propose</span>
                    <span class="column-count" id="countCall">0</span>
                </div>
                <div class="column-body" id="colCall"></div>
            </div>
            <div class="column" data-status="closed">
                <div class="column-header">
                    <span class="column-title">Close</span>
                    <span class="column-count" id="countClosed">0</span>
                </div>
                <div class="column-body" id="colClosed"></div>
            </div>
            <div class="column" data-status="pilot">
                <div class="column-header">
                    <span class="column-title">Delivery</span>
                    <span class="column-count" id="countPilot">0</span>
                </div>
                <div class="column-body" id="colPilot"></div>
            </div>
            <div class="column" data-status="client">
                <div class="column-header">
                    <span class="column-title">Report</span>
                    <span class="column-count" id="countClient">0</span>
                </div>
                <div class="column-body" id="colClient"></div>
            </div>
            <div class="column" data-status="lost">
                <div class="column-header">
                    <span class="column-title">Recontact</span>
                    <span class="column-count" id="countLost">0</span>
                </div>
                <div class="column-body" id="colLost"></div>
            </div>
        </div>

        <div class="list-view" id="listView">
            <table class="prospects-table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Company</th>
                        <th>Status</th>
                        <th>Move</th>
                        <th>Follow-up</th>
                        <th>Email</th>
                    </tr>
                </thead>
                <tbody id="listBody"></tbody>
            </table>
        </div>
    </div>

    <div class="modal-overlay" id="modal">
        <div class="modal">
            <h2 id="modalTitle">Add Prospect</h2>
            <form id="prospectForm">
                <input type="hidden" id="prospectId">
                <div class="form-group">
                    <label>Name *</label>
                    <input type="text" id="prospectName" required placeholder="John Smith">
                </div>
                <div class="form-group">
                    <label>Company</label>
                    <input type="text" id="prospectCompany" placeholder="Acme Inc">
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="prospectEmail" placeholder="john@acme.com">
                </div>
                <div class="form-group">
                    <label>LinkedIn</label>
                    <input type="text" id="prospectLinkedin" placeholder="linkedin.com/in/johnsmith">
                </div>
                <div class="form-group">
                    <label>Status</label>
                    <select id="prospectStatus">
                        <option value="new">Target</option>
                        <option value="contacted">Contacted</option>
                        <option value="responded">Present</option>
                        <option value="call_scheduled">Propose</option>
                        <option value="closed">Close</option>
                        <option value="pilot">Delivery</option>
                        <option value="client">Report</option>
                        <option value="lost">Recontact</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Next Follow-up</label>
                    <input type="date" id="prospectFollowup">
                </div>
                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="prospectNotes" placeholder="Add any relevant notes..."></textarea>
                </div>
                <div class="calls-section" id="callsSection" style="display: none;">
                    <div class="calls-section-header">
                        <span class="calls-section-title">Call History</span>
                        <button type="button" class="btn btn-secondary" id="loadCallsBtn" onclick="loadCallsForCurrentProspect()">Load call history</button>
                    </div>
                    <div class="calls-list" id="callsList">
                        <div class="calls-empty">Call history loads on demand.</div>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    <button type="button" class="btn btn-danger" id="deleteBtn" style="display:none" onclick="deleteProspect()">Delete</button>
                    <button type="submit" class="btn">Save</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const SAFE_MODE = true;
        const SPEED_MODE = true;

        let prospects = [];
        let draggedProspectId = null;
        let currentView = 'pipeline';
        let currentDayView = 'today'; // 'today' or 'tomorrow'
        let currentModalProspectId = null;

        if (SAFE_MODE) {
            document.documentElement.classList.add('safe-mode');
        }

        if (SPEED_MODE) {
            window.addEventListener('DOMContentLoaded', () => {
                const historyBtn = document.querySelector('.history-btn');
                const unmatchedBtn = document.getElementById('unmatchedCallsBtn');
                if (historyBtn) historyBtn.style.display = 'none';
                if (unmatchedBtn) unmatchedBtn.style.display = 'none';
            });
        }

        const statusColumns = {
            new: 'colNew',
            contacted: 'colContacted',
            responded: 'colResponded',
            call_scheduled: 'colCall',
            closed: 'colClosed',
            pilot: 'colPilot',
            client: 'colClient',
            lost: 'colLost'
        };

        const statusNext = {
            new: 'contacted',
            contacted: 'responded',
            responded: 'call_scheduled',
            call_scheduled: 'closed',
            closed: 'pilot',
            pilot: 'client'
        };

        const statusLabels = {
            new: 'Target',
            contacted: 'Contacted',
            responded: 'Present',
            call_scheduled: 'Propose',
            closed: 'Close',
            pilot: 'Delivery',
            client: 'Report',
            lost: 'Recontact'
        };

        const PROSPECT_FIELDS = 'id,name,company,email,status,next_followup,updated_at';

        // Weekly Readings Data
        // First class date: Week 1 was Dec 31, 2025 (Wednesday)
        const COURSE_START_DATE = new Date('2025-12-31');

        const WEEKLY_READINGS = {
            1: {
                title: 'Developing a Sense of Self: Dibs',
                readings: [
                    { text: 'Axline, Virginia Mae (2022) Dibs in Search of Self: Personality Development in Play Therapy. London: Penguin Classics.' },
                    { text: 'Axline, Virginia Mae (1971) Dibs, in Search of Self. Harmondsworth: Penguin Books.', note: 'Alternative if later edition not available' }
                ]
            },
            2: {
                title: 'Developing Counselling Skills: Silence, Listening and Responding',
                readings: [
                    { text: 'Coltart, Nina (1992) Slouching Towards Bethlehem. London: Free Association.', note: 'Chapter 6: "The Silent Patient"' },
                    { text: 'Howard, Susan (2010) Skills in Psychodynamic Counselling and Psychotherapy. London: SAGE.' }
                ]
            },
            3: {
                title: 'Establishing and Challenging the Therapeutic Frame',
                readings: [
                    { text: 'Gray, Anne (1994) An Introduction to the Therapeutic Frame. London: Routledge.', note: 'Chapter 1: "The Frame"' },
                    { text: 'Gabbard, Glen O. (2016) Boundaries and Boundary Violations in Psychoanalysis. 2nd ed. Arlington, VA: APA.', note: 'Chapter 5 only' },
                    { text: 'Winnicott, D. W. (1992) Through Paediatrics to Psycho-analysis. London: Karnac.', note: 'Chapter XXV: "The Antisocial Tendency"' }
                ]
            },
            4: {
                title: 'Working with the Unknown',
                readings: [
                    { text: 'Gerrard, Jackie (2018) "Dilemmas of a Psychotherapist." In The Impossibility of Knowing.', note: 'Section 3, Chapter 9' },
                    { text: 'Ogden, Thomas H. (1992) The Primitive Edge of Experience.', note: 'Chapter 7: "The Initial Analytic Meeting"' }
                ]
            },
            5: {
                title: 'Working with Anxiety',
                readings: [
                    { text: 'Curtis, Hannah (2015) "Anxiety." In Everyday Life and the Unconscious Mind.', note: 'Read before Freud lecture' },
                    { text: 'Freud, Sigmund (2024) Revised Standard Edition.', note: 'Lecture XXXII, Vol. XXII' }
                ]
            },
            6: {
                title: 'Working with Difference',
                readings: [
                    { text: 'Wheeler, Sue (2006) Difference and Diversity in Counselling.', note: 'Part 1' }
                ]
            },
            7: {
                title: 'Working with Loss and Grief',
                readings: [
                    { text: 'Berzoff, Joan (2003) "Psychodynamic Theories in Grief and Bereavement." Smith College Studies in Social Work, 73 (3).' },
                    { text: 'Fiorini et al. (2007) On Freud\'s \'Mourning and Melancholia\'.', note: 'Part 1 only' }
                ]
            },
            8: {
                title: 'Working with Guilt and Shame',
                readings: [
                    { text: 'Klein, Melanie (1998) Love, Guilt and Reparation.', note: '"Love, Guilt and Reparation" (1937)' },
                    { text: 'Mollon, Phil (2018) "Shame and Jealousy."' },
                    { text: 'Winnicott, D. W. (2018) "Psychoanalysis and the Sense of Guilt."' }
                ]
            },
            9: {
                title: 'Working with Rage and Anger',
                readings: [
                    { text: 'Noonan, Ellen & Noonan, Frederick (2008) "Surviving Rage."' },
                    { text: 'Strozier et al. (2017) "Heinz Kohut\'s Theory of Aggression and Rage."' }
                ]
            },
            10: {
                title: 'Consolidation',
                readings: []
            }
        };

        function getCurrentReadingWeek() {
            const now = new Date();
            const msPerWeek = 7 * 24 * 60 * 60 * 1000;
            const weeksSinceStart = Math.floor((now - COURSE_START_DATE) / msPerWeek);
            // Week N starts on the (N-1)th Wednesday after course start
            // Readings automatically transition each Wednesday at midnight
            const week = weeksSinceStart + 1;
            return Math.max(1, Math.min(week, 10));
        }

        function getReadingsCompleted() {
            const completed = localStorage.getItem('readingsCompleted');
            return completed ? JSON.parse(completed) : {};
        }

        function setReadingCompleted(week, index, completed) {
            const allCompleted = getReadingsCompleted();
            if (!allCompleted[week]) allCompleted[week] = {};
            allCompleted[week][index] = completed;
            localStorage.setItem('readingsCompleted', JSON.stringify(allCompleted));
            renderReadings();
        }

        function toggleReadings() {
            const header = document.getElementById('readingsHeader');
            const list = document.getElementById('readingsList');
            header.classList.toggle('expanded');
            list.classList.toggle('expanded');
        }

        function renderReadings() {
            if (SPEED_MODE) {
                const indicator = document.getElementById('readingsIndicator');
                if (indicator) indicator.style.display = 'none';
                return;
            }

            const week = getCurrentReadingWeek();
            const weekData = WEEKLY_READINGS[week];
            const completed = getReadingsCompleted()[week] || {};

            document.getElementById('readingsWeek').textContent = `Week ${week}`;

            const readings = weekData?.readings || [];
            const completedCount = Object.values(completed).filter(Boolean).length;
            const countEl = document.getElementById('readingsCount');

            if (readings.length === 0) {
                countEl.innerHTML = '<span class="readings-progress">No essential readings</span>';
            } else if (completedCount === readings.length) {
                countEl.innerHTML = `<span class="readings-progress">${completedCount}/${readings.length} done</span>`;
            } else {
                countEl.textContent = `${readings.length} essential reading${readings.length > 1 ? 's' : ''}`;
            }

            const listEl = document.getElementById('readingsList');
            if (readings.length === 0) {
                listEl.innerHTML = '<div class="reading-text" style="padding: 8px 0;">No essential readings this week. Review recommended texts from previous weeks.</div>';
                return;
            }

            listEl.innerHTML = readings.map((r, i) => `
                <div class="reading-item ${completed[i] ? 'completed' : ''}">
                    <div class="reading-checkbox ${completed[i] ? 'checked' : ''}" onclick="setReadingCompleted(${week}, ${i}, ${!completed[i]})"></div>
                    <div>
                        <div class="reading-text">${r.text}</div>
                        ${r.note ? `<div class="reading-note">${r.note}</div>` : ''}
                    </div>
                </div>
            `).join('');
        }

        const today = new Date().toDateString();

        // One Thing
        function getOneThingKey() {
            return currentDayView === 'today' ? 'oneThing' : 'oneThingTomorrow';
        }

        function loadOneThing() {
            const key = getOneThingKey();
            let value = localStorage.getItem(key) || '';
            let dateKey = key + 'Date';
            let savedDate = localStorage.getItem(dateKey);

            // For today's one thing, check if it's a new day and load from yesterday's tomorrow
            if (currentDayView === 'today' && savedDate !== today) {
                const tomorrowValue = localStorage.getItem('oneThingTomorrow') || '';
                value = tomorrowValue;
                localStorage.setItem('oneThing', value);
                localStorage.setItem('oneThingDate', today);
                // Clear tomorrow's planning
                localStorage.setItem('oneThingTomorrow', '');
            }

            document.getElementById('oneThingInput').value = value;
        }

        function saveOneThing(value) {
            const key = getOneThingKey();
            const dateKey = key + 'Date';
            localStorage.setItem(key, value);
            localStorage.setItem(dateKey, today);

            // Sync to backend for daily email (both today and tomorrow)
            syncDailyPlanning();
        }

        // Sync daily planning to backend for email summaries
        async function syncDailyPlanning() {
            if (SPEED_MODE) return;
            try {
                // Always sync both today and tomorrow to Supabase
                const todayOneThing = localStorage.getItem('oneThing') || '';
                const todayTasks = JSON.parse(localStorage.getItem('dailyTasks') || '[]');

                const tomorrowOneThing = localStorage.getItem('oneThingTomorrow') || '';
                const tomorrowTasks = JSON.parse(localStorage.getItem('dailyTasksTomorrow') || '[]');

                // Sync today
                await fetch('/api/daily-planning', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        date: new Date().toISOString().split('T')[0],
                        oneThing: todayOneThing,
                        tasks: todayTasks
                    })
                });

                // Sync tomorrow
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                await fetch('/api/daily-planning', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        date: tomorrow.toISOString().split('T')[0],
                        oneThing: tomorrowOneThing,
                        tasks: tomorrowTasks
                    })
                });
            } catch (error) {
                console.error('Failed to sync daily planning:', error);
            }
        }

        function normalizeServerTasks(rawTasks) {
            let tasks = [];
            if (Array.isArray(rawTasks)) {
                tasks = rawTasks;
            } else if (typeof rawTasks === 'string') {
                try {
                    tasks = JSON.parse(rawTasks);
                } catch (error) {
                    tasks = [];
                }
            }

            if (!Array.isArray(tasks)) return [];
            return tasks.slice(0, MAX_TASKS).map(task => ({
                text: task?.text || '',
                completed: Boolean(task?.completed),
                dbId: task?.dbId || task?.db_id || null
            }));
        }

        function applyServerPlanning(planning, target) {
            if (!planning) return;
            const dateStamp = new Date().toDateString();
            const oneThingKey = target === 'today' ? 'oneThing' : 'oneThingTomorrow';
            const oneThingDateKey = oneThingKey + 'Date';
            const tasksKey = target === 'today' ? 'dailyTasks' : 'dailyTasksTomorrow';
            const tasksDateKey = tasksKey + 'Date';

            if (planning.one_thing !== null && planning.one_thing !== undefined) {
                localStorage.setItem(oneThingKey, planning.one_thing || '');
                localStorage.setItem(oneThingDateKey, dateStamp);
            }

            if (planning.tasks !== null && planning.tasks !== undefined) {
                const tasks = normalizeServerTasks(planning.tasks);
                localStorage.setItem(tasksKey, JSON.stringify(tasks));
                localStorage.setItem(tasksDateKey, dateStamp);
            }
        }

        async function syncDailyPlanningFromServer() {
            if (SPEED_MODE) return;
            try {
                const todayIso = new Date().toISOString().split('T')[0];
                const tomorrowDate = new Date();
                tomorrowDate.setDate(tomorrowDate.getDate() + 1);
                const tomorrowIso = tomorrowDate.toISOString().split('T')[0];

                const [todayRes, tomorrowRes] = await Promise.all([
                    fetch(`/api/daily-planning?date=${todayIso}`),
                    fetch(`/api/daily-planning?date=${tomorrowIso}`)
                ]);

                if (todayRes.ok) {
                    const todayPlanning = await todayRes.json();
                    applyServerPlanning(todayPlanning, 'today');
                }
                if (tomorrowRes.ok) {
                    const tomorrowPlanning = await tomorrowRes.json();
                    applyServerPlanning(tomorrowPlanning, 'tomorrow');
                }

                loadOneThing();
                loadDailyTasks();
                renderDailyTasks();
            } catch (error) {
                console.error('Failed to load planning from server:', error);
            }
        }

        // Daily Tasks
        const MAX_TASKS = 3;
        let dailyTasks = [];
        let tomorrowTasks = [];

        function getDailyTasksKey() {
            return currentDayView === 'today' ? 'dailyTasks' : 'dailyTasksTomorrow';
        }

        function loadDailyTasks() {
            const key = getDailyTasksKey();
            let tasks = JSON.parse(localStorage.getItem(key) || '[]');
            const dateKey = key + 'Date';
            let savedDate = localStorage.getItem(dateKey);

            // For today's tasks, check if it's a new day and load from yesterday's tomorrow
            if (currentDayView === 'today' && savedDate !== today) {
                // Save yesterday's completed tasks for the email
                const yesterdayTasks = JSON.parse(localStorage.getItem('dailyTasks') || '[]');
                localStorage.setItem('dailyTasksYesterday', JSON.stringify(yesterdayTasks));
                localStorage.setItem('dailyTasksYesterdayDate', today);

                // Load tomorrow's tasks as today's tasks
                const tomorrowPlanned = JSON.parse(localStorage.getItem('dailyTasksTomorrow') || '[]');
                tasks = tomorrowPlanned.map(t => ({ ...t, completed: false })); // Reset completion
                localStorage.setItem('dailyTasks', JSON.stringify(tasks));
                localStorage.setItem('dailyTasksDate', today);
                // Clear tomorrow's planning
                localStorage.setItem('dailyTasksTomorrow', '[]');
            }

            if (currentDayView === 'today') {
                dailyTasks = tasks;
            } else {
                tomorrowTasks = tasks;
            }
        }

        function saveDailyTasks() {
            const key = getDailyTasksKey();
            const dateKey = key + 'Date';
            const tasks = currentDayView === 'today' ? dailyTasks : tomorrowTasks;
            localStorage.setItem(key, JSON.stringify(tasks));
            localStorage.setItem(dateKey, today);

            // Sync to backend for daily email (both today and tomorrow)
            syncDailyPlanning();
        }

        function getCurrentTasks() {
            return currentDayView === 'today' ? dailyTasks : tomorrowTasks;
        }

        function setCurrentTasks(tasks) {
            if (currentDayView === 'today') {
                dailyTasks = tasks;
            } else {
                tomorrowTasks = tasks;
            }
        }

        function renderDailyTasks() {
            const container = document.getElementById('dailyTasksList');
            const tasks = getCurrentTasks();
            let html = '';

            tasks.forEach((task, index) => {
                html += `
                    <div class="daily-task ${task.completed ? 'completed' : ''}" data-index="${index}">
                        <div class="daily-task-checkbox" onclick="toggleDailyTask(${index})"></div>
                        <input type="text" class="daily-task-input" value="${escapeHtml(task.text)}"
                            placeholder="What's your focus?"
                            onchange="updateDailyTask(${index}, this.value)"
                            ${task.completed ? 'readonly' : ''}>
                        <button class="daily-task-delete" onclick="deleteDailyTask(${index})"></button>
                    </div>
                `;
            });

            if (tasks.length < MAX_TASKS) {
                html += `<button class="add-task-btn" onclick="addDailyTask()">+ Add task (${tasks.length}/${MAX_TASKS})</button>`;
            }

            container.innerHTML = html;
        }

        function addDailyTask() {
            const tasks = getCurrentTasks();
            if (tasks.length >= MAX_TASKS) return;
            tasks.push({ text: '', completed: false, dbId: null });
            setCurrentTasks(tasks);
            saveDailyTasks();
            renderDailyTasks();
            // Focus the new input
            setTimeout(() => {
                const inputs = document.querySelectorAll('.daily-task-input');
                inputs[inputs.length - 1]?.focus();
            }, 10);
        }

        async function updateDailyTask(index, text) {
            const tasks = getCurrentTasks();
            const oldText = tasks[index].text;
            tasks[index].text = text;
            setCurrentTasks(tasks);
            saveDailyTasks();

            // Save to database if text is not empty and this is for today
            if (currentDayView === 'today' && text.trim() !== '') {
                if (!tasks[index].dbId && oldText.trim() === '') {
                    // New task - create in database
                    const saved = await saveTaskToDb(text, tasks[index].completed);
                    if (saved && saved.id) {
                        tasks[index].dbId = saved.id;
                        setCurrentTasks(tasks);
                        saveDailyTasks();
                    }
                } else if (tasks[index].dbId) {
                    // Existing task - update text in database
                    try {
                        await fetch(`/api/task?id=${tasks[index].dbId}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ text: text, completed: tasks[index].completed })
                        });
                    } catch (error) {
                        console.error('Failed to update task:', error);
                    }
                }
            }
        }

        async function toggleDailyTask(index) {
            const tasks = getCurrentTasks();
            tasks[index].completed = !tasks[index].completed;
            setCurrentTasks(tasks);
            saveDailyTasks();
            renderDailyTasks();

            // Persist for history even if the task hasn't been saved yet
            if (currentDayView === 'today' && tasks[index].text.trim() !== '') {
                if (!tasks[index].dbId) {
                    const saved = await saveTaskToDb(tasks[index].text, tasks[index].completed);
                    if (saved && saved.id) {
                        tasks[index].dbId = saved.id;
                        setCurrentTasks(tasks);
                        saveDailyTasks();
                    }
                } else {
                    await updateTaskInDb(tasks[index].dbId, tasks[index].completed);
                }
            }

            // Check if all tasks are completed (only for today)
            if (currentDayView === 'today') {
                const hasActiveTasks = tasks.some(t => t.text.trim() !== '');
                const allCompleted = hasActiveTasks && tasks.filter(t => t.text.trim() !== '').every(t => t.completed);

                if (allCompleted) {
                    showCelebration();
                }
            }
        }

        async function deleteDailyTask(index) {
            const tasks = getCurrentTasks();
            const task = tasks[index];
            tasks.splice(index, 1);
            setCurrentTasks(tasks);
            saveDailyTasks();
            renderDailyTasks();

            // Keep a history record for today's tasks, even when removed from the list
            if (currentDayView === 'today' && task.text.trim() !== '') {
                if (!task.dbId) {
                    const saved = await saveTaskToDb(task.text, task.completed);
                    if (saved && saved.id) {
                        task.dbId = saved.id;
                    }
                } else {
                    await updateTaskInDb(task.dbId, task.completed);
                }
            }
        }

        function showCelebration() {
            const celebration = document.getElementById('celebration');
            celebration.classList.add('active');

            // Add confetti
            const colors = ['#22c55e', '#3b82f6', '#f59e0b', '#ef4444', '#a855f7', '#ec4899'];
            for (let i = 0; i < 50; i++) {
                setTimeout(() => {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';
                    confetti.style.left = Math.random() * 100 + 'vw';
                    confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
                    confetti.style.animationDelay = Math.random() * 0.5 + 's';
                    celebration.appendChild(confetti);

                    setTimeout(() => confetti.remove(), 3000);
                }, i * 50);
            }
        }

        function closeCelebration() {
            document.getElementById('celebration').classList.remove('active');
        }

        // Day View Toggle
        function setDayView(view) {
            currentDayView = view;
            const btnToday = document.getElementById('btnToday');
            const btnTomorrow = document.getElementById('btnTomorrow');
            const banner = document.getElementById('planningBanner');
            const oneThingLabel = document.getElementById('oneThingLabel');
            const dailyTasksTitle = document.getElementById('dailyTasksTitle');
            const oneThingInput = document.getElementById('oneThingInput');

            if (view === 'today') {
                btnToday.classList.add('active');
                btnTomorrow.classList.remove('active');
                banner.classList.remove('active');
                oneThingLabel.textContent = 'The One Thing';
                dailyTasksTitle.textContent = "Today's Main Tasks";
                oneThingInput.placeholder = 'What matters most today?';
            } else {
                btnToday.classList.remove('active');
                btnTomorrow.classList.add('active');
                banner.classList.add('active');
                oneThingLabel.textContent = 'Tomorrow\'s One Thing';
                dailyTasksTitle.textContent = "Tomorrow's Main Tasks";
                oneThingInput.placeholder = 'What matters most tomorrow?';
            }

            loadOneThing();
            loadDailyTasks();
            renderDailyTasks();
        }

        // Initialize
        loadOneThing();
        loadDailyTasks();
        renderDailyTasks();
        syncDailyPlanningFromServer();

        function setView(view) {
            currentView = view;
            const pipeline = document.querySelector('.pipeline');
            const listView = document.getElementById('listView');
            const btnPipeline = document.getElementById('btnPipeline');
            const btnList = document.getElementById('btnList');

            if (view === 'pipeline') {
                pipeline.classList.remove('hidden');
                listView.classList.remove('active');
                btnPipeline.classList.add('active');
                btnList.classList.remove('active');
            } else {
                pipeline.classList.add('hidden');
                listView.classList.add('active');
                btnPipeline.classList.remove('active');
                btnList.classList.add('active');
                renderListView();
            }
        }

        function renderListView() {
            const tbody = document.getElementById('listBody');
            if (prospects.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="table-empty">No prospects yet. Add your first one!</td></tr>';
                return;
            }
            tbody.innerHTML = prospects.map(p => {
                let followupText = '-';
                if (p.next_followup) {
                    const date = new Date(p.next_followup);
                    const today = new Date();
                    today.setHours(0,0,0,0);
                    const isOverdue = date < today;
                    followupText = `<span style="color: ${isOverdue ? '#ef4444' : '#f59e0b'}">${date.toLocaleDateString()}</span>`;
                }
                return `
                    <tr onclick="editProspect(prospects.find(pr => pr.id === ${p.id}))">
                        <td><strong>${escapeHtml(p.name)}</strong></td>
                        <td>${escapeHtml(p.company) || '-'}</td>
                        <td><span class="status-badge ${p.status}">${statusLabels[p.status]}</span></td>
                        <td>
                            <select onchange="event.stopPropagation(); moveToStatus(${p.id}, this.value)" onclick="event.stopPropagation()" style="padding:6px 8px; border-radius:8px; background:#1f2937; color:#fff; border:1px solid #374151;">
                                ${Object.entries(statusLabels).map(([key,label]) => `<option value="${key}" ${p.status === key ? 'selected' : ''}>${label}</option>`).join('')}
                            </select>
                        </td>
                        <td>${followupText}</td>
                        <td>${escapeHtml(p.email) || '-'}</td>
                    </tr>
                `;
            }).join('');
        }

        async function loadProspects() {
            const res = await fetch(`/api/prospects?fields=${encodeURIComponent(PROSPECT_FIELDS)}`);
            prospects = await res.json();
            renderPipeline();
            if (currentView === 'list') renderListView();
            loadStats(prospects);
        }

        function computeStatsFromProspects(list) {
            const statusCounts = {};
            list.forEach(p => {
                const status = p.status || 'new';
                statusCounts[status] = (statusCounts[status] || 0) + 1;
            });

            const total = list.length;
            const closed = statusCounts.closed || 0;
            const conversionRate = total > 0 ? Math.round((closed / total * 100) * 10) / 10 : 0;

            const respondedPlus = (
                (statusCounts.responded || 0) +
                (statusCounts.call_scheduled || 0) +
                (statusCounts.closed || 0) +
                (statusCounts.pilot || 0) +
                (statusCounts.client || 0) +
                (statusCounts.lost || 0)
            );
            const contactedTotal = total - (statusCounts.new || 0);
            const responseRate = contactedTotal > 0
                ? Math.round((respondedPlus / Math.max(contactedTotal, 1) * 100) * 10) / 10
                : 0;

            return {
                total: total,
                by_status: statusCounts,
                conversion_rate: conversionRate,
                response_rate: responseRate
            };
        }

        function updateStatsUI(stats) {
            document.getElementById('statTotal').textContent = stats.total;
            document.getElementById('statContacted').textContent = stats.by_status.contacted || 0;
            document.getElementById('statResponded').textContent = stats.by_status.responded || 0;
            document.getElementById('statCalls').textContent = stats.by_status.call_scheduled || 0;
            document.getElementById('statClosed').textContent = stats.by_status.closed || 0;
            document.getElementById('statResponseRate').textContent = stats.response_rate + '%';

            document.getElementById('countNew').textContent = stats.by_status.new || 0;
            document.getElementById('countContacted').textContent = stats.by_status.contacted || 0;
            document.getElementById('countResponded').textContent = stats.by_status.responded || 0;
            document.getElementById('countCall').textContent = stats.by_status.call_scheduled || 0;
            document.getElementById('countClosed').textContent = stats.by_status.closed || 0;
            document.getElementById('countPilot').textContent = stats.by_status.pilot || 0;
            document.getElementById('countClient').textContent = stats.by_status.client || 0;
            document.getElementById('countLost').textContent = stats.by_status.lost || 0;

            const closed = stats.by_status.closed || 0;
            document.getElementById('goalProgress').textContent = `${closed} / 3 closed`;
            document.getElementById('goalProgressBar').style.width = `${Math.min(closed / 3 * 100, 100)}%`;

            if (closed >= 3) {
                document.getElementById('goalText').textContent = 'Goal reached! Keep going!';
            } else {
                const needed = 3 - closed;
                document.getElementById('goalText').textContent = `${needed} more closed deal${needed > 1 ? 's' : ''} to reach your goal`;
            }
        }

        async function loadStats(list) {
            if (Array.isArray(list)) {
                updateStatsUI(computeStatsFromProspects(list));
                return;
            }

            const res = await fetch('/api/stats');
            const stats = await res.json();
            updateStatsUI(stats);
        }

        function renderPipeline() {
            Object.values(statusColumns).forEach(colId => {
                document.getElementById(colId).innerHTML = '';
            });
            prospects.forEach(p => {
                const col = document.getElementById(statusColumns[p.status]);
                if (col) col.appendChild(createProspectCard(p));
            });
            Object.entries(statusColumns).forEach(([status, colId]) => {
                const col = document.getElementById(colId);
                if (col.children.length === 0) {
                    col.innerHTML = '<div class="empty-state"><p>No prospects</p></div>';
                }
            });
        }

        function createProspectCard(prospect) {
            const card = document.createElement('div');
            card.className = `prospect-card status-${prospect.status}`;
            card.draggable = !SAFE_MODE;
            card.dataset.id = prospect.id;

            if (!SAFE_MODE) {
                card.ondragstart = (e) => {
                    draggedProspectId = prospect.id;
                    card.classList.add('dragging');
                    e.dataTransfer.effectAllowed = 'move';
                };
                card.ondragend = () => {
                    card.classList.remove('dragging');
                    draggedProspectId = null;
                };
            }
            card.onclick = (e) => {
                if (!e.target.classList.contains('quick-btn')) editProspect(prospect);
            };

            let followupHtml = '';
            if (prospect.next_followup) {
                const followupDate = new Date(prospect.next_followup);
                const today = new Date();
                today.setHours(0,0,0,0);
                const isOverdue = followupDate < today;
                followupHtml = `<div class="prospect-followup ${isOverdue ? 'overdue' : ''}">
                    ${isOverdue ? 'Overdue: ' : 'Follow-up: '}${followupDate.toLocaleDateString()}
                </div>`;
            }

            const nextStatus = statusNext[prospect.status];
            card.innerHTML = `
                <div class="prospect-name">${escapeHtml(prospect.name)}</div>
                ${prospect.company ? `<div class="prospect-company">${escapeHtml(prospect.company)}</div>` : ''}
                ${followupHtml}
                <div class="quick-actions">
                    ${nextStatus ? `<button class="quick-btn" onclick="event.stopPropagation(); moveToStatus(${prospect.id}, '${nextStatus}')">
                        Move to ${nextStatus.replace('_', ' ')}
                    </button>` : ''}
                    ${prospect.status !== 'lost' && prospect.status !== 'closed' ? `<button class="quick-btn" onclick="event.stopPropagation(); moveToStatus(${prospect.id}, 'lost')">
                        Mark lost
                    </button>` : ''}
                </div>
            `;
            return card;
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function moveToStatus(id, status) {
            await fetch(`/api/prospects/${id}/status`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status })
            });
            loadProspects();
        }

        function openModal(prospect = null) {
            const modal = document.getElementById('modal');
            const form = document.getElementById('prospectForm');
            const title = document.getElementById('modalTitle');
            const deleteBtn = document.getElementById('deleteBtn');
            const callsSection = document.getElementById('callsSection');
            const callsList = document.getElementById('callsList');
            const loadCallsBtn = document.getElementById('loadCallsBtn');

            form.reset();

            if (prospect) {
                currentModalProspectId = prospect.id;
                title.textContent = 'Edit Prospect';
                deleteBtn.style.display = 'block';
                document.getElementById('prospectId').value = prospect.id;
                document.getElementById('prospectName').value = prospect.name || '';
                document.getElementById('prospectCompany').value = prospect.company || '';
                document.getElementById('prospectEmail').value = prospect.email || '';
                document.getElementById('prospectLinkedin').value = prospect.linkedin || '';
                document.getElementById('prospectStatus').value = prospect.status || 'new';
                document.getElementById('prospectFollowup').value = prospect.next_followup || '';
                document.getElementById('prospectNotes').value = prospect.notes || '';

                if (SAFE_MODE) {
                    callsSection.style.display = 'none';
                } else {
                    callsSection.style.display = 'block';
                    callsList.innerHTML = '<div class="calls-empty">Call history loads on demand.</div>';
                    loadCallsBtn.disabled = false;
                    loadCallsBtn.textContent = 'Load call history';
                }
            } else {
                currentModalProspectId = null;
                title.textContent = 'Add Prospect';
                deleteBtn.style.display = 'none';
                document.getElementById('prospectId').value = '';
                callsSection.style.display = 'none';
            }
            modal.classList.add('active');
        }

        function closeModal() {
            currentModalProspectId = null;
            document.getElementById('modal').classList.remove('active');
        }

        async function editProspect(prospect) {
            if (!prospect) return;
            const needsDetails = typeof prospect.linkedin === 'undefined' || typeof prospect.notes === 'undefined';
            if (needsDetails) {
                try {
                    const res = await fetch(`/api/prospect?id=${prospect.id}`);
                    if (res.ok) {
                        const fullProspect = await res.json();
                        if (fullProspect) {
                            prospect = fullProspect;
                        }
                    }
                } catch (error) {
                    console.error('Failed to load prospect details:', error);
                }
            }
            openModal(prospect);
        }

        async function deleteProspect() {
            const id = document.getElementById('prospectId').value;
            if (!id) return;
            if (confirm('Delete this prospect?')) {
                await fetch(`/api/prospects/${id}`, { method: 'DELETE' });
                closeModal();
                loadProspects();
            }
        }

        document.getElementById('prospectForm').onsubmit = async (e) => {
            e.preventDefault();
            const id = document.getElementById('prospectId').value;
            const data = {
                name: document.getElementById('prospectName').value,
                company: document.getElementById('prospectCompany').value,
                email: document.getElementById('prospectEmail').value,
                linkedin: document.getElementById('prospectLinkedin').value,
                status: document.getElementById('prospectStatus').value,
                next_followup: document.getElementById('prospectFollowup').value || null,
                notes: document.getElementById('prospectNotes').value
            };

            if (id) {
                await fetch(`/api/prospects/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
            } else {
                await fetch('/api/prospects', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
            }
            closeModal();
            loadProspects();
        };

        document.getElementById('modal').onclick = (e) => {
            if (e.target.id === 'modal') closeModal();
        };

        document.onkeydown = (e) => {
            if (e.key === 'Escape') closeModal();
        };

        function setupDropZones() {
            if (SAFE_MODE) return;

            document.querySelectorAll('.column').forEach(column => {
                const status = column.dataset.status;
                const body = column.querySelector('.column-body');

                body.ondragover = (e) => {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'move';
                };
                body.ondragenter = (e) => {
                    e.preventDefault();
                    body.classList.add('drag-over');
                };
                body.ondragleave = (e) => {
                    if (!body.contains(e.relatedTarget)) body.classList.remove('drag-over');
                };
                body.ondrop = async (e) => {
                    e.preventDefault();
                    body.classList.remove('drag-over');
                    if (draggedProspectId) await moveToStatus(draggedProspectId, status);
                };
            });
        }

        setupDropZones();
        if (SAFE_MODE) {
            setView('list');
        }
        loadProspects();
        renderReadings();

        // Draggable Goal Window
        const goalFloat = document.getElementById('goalFloat');
        let isDragging = false;
        let dragOffset = { x: 0, y: 0 };

        // Load saved position
        const savedPos = JSON.parse(localStorage.getItem('goalFloatPos') || 'null');
        if (savedPos) {
            goalFloat.style.top = savedPos.top + 'px';
            goalFloat.style.left = savedPos.left + 'px';
            goalFloat.style.right = 'auto';
        }

        goalFloat.addEventListener('mousedown', (e) => {
            isDragging = true;
            dragOffset.x = e.clientX - goalFloat.offsetLeft;
            dragOffset.y = e.clientY - goalFloat.offsetTop;
            goalFloat.style.right = 'auto';
        });

        document.addEventListener('mousemove', (e) => {
            if (!isDragging) return;
            const x = Math.max(0, Math.min(e.clientX - dragOffset.x, window.innerWidth - goalFloat.offsetWidth));
            const y = Math.max(0, Math.min(e.clientY - dragOffset.y, window.innerHeight - goalFloat.offsetHeight));
            goalFloat.style.left = x + 'px';
            goalFloat.style.top = y + 'px';
        });

        document.addEventListener('mouseup', () => {
            if (isDragging) {
                isDragging = false;
                localStorage.setItem('goalFloatPos', JSON.stringify({
                    top: goalFloat.offsetTop,
                    left: goalFloat.offsetLeft
                }));
            }
        });

        // Task History Panel
        let allTasks = [];
        let historyFilter = 'all';
        const HISTORY_PAGE_SIZE = 200;
        let historyOffset = 0;
        let historyHasMore = true;
        let historyLoading = false;

        function openHistory() {
            if (SPEED_MODE) return;
            document.getElementById('historyPanel').classList.add('active');
            document.getElementById('historyOverlay').classList.add('active');
            document.body.style.overflow = 'hidden';
            loadTaskHistory(true);
        }

        function closeHistory() {
            document.getElementById('historyPanel').classList.remove('active');
            document.getElementById('historyOverlay').classList.remove('active');
            document.body.style.overflow = '';
        }

        async function loadTaskHistory(reset = false) {
            const content = document.getElementById('historyContent');
            if (historyLoading) return;

            if (reset) {
                allTasks = [];
                historyOffset = 0;
                historyHasMore = true;
                content.innerHTML = '<div class="history-loading">Loading tasks...</div>';
            }

            try {
                historyLoading = true;
                const res = await fetch(`/api/tasks?limit=${HISTORY_PAGE_SIZE}&offset=${historyOffset}`);
                const page = await res.json();
                const existing = new Set(allTasks.map(task => task.id));
                page.forEach(task => {
                    if (!task.id || !existing.has(task.id)) {
                        allTasks.push(task);
                    }
                });
                historyOffset += page.length;
                historyHasMore = page.length === HISTORY_PAGE_SIZE;
                updateHistoryStats();
                renderTaskHistory();
            } catch (error) {
                console.error('Failed to load task history:', error);
                content.innerHTML = '<div class="history-empty"><div class="history-empty-icon">!</div><p>Failed to load tasks</p></div>';
            } finally {
                historyLoading = false;
            }
        }

        function loadMoreHistory() {
            if (historyHasMore) {
                loadTaskHistory(false);
            }
        }

        function updateHistoryStats() {
            const completed = allTasks.filter(t => t.completed).length;
            const total = allTasks.length;
            const rate = total > 0 ? Math.round((completed / total) * 100) : 0;

            document.getElementById('historyCompleted').textContent = completed;
            document.getElementById('historyTotal').textContent = total;
            document.getElementById('historyRate').textContent = rate + '%';
        }

        function setHistoryFilter(filter) {
            historyFilter = filter;
            document.querySelectorAll('.history-filter').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.filter === filter);
            });
            renderTaskHistory();
        }

        function renderTaskHistory() {
            const content = document.getElementById('historyContent');
            let tasks = [...allTasks];

            // Apply filter
            if (historyFilter === 'completed') {
                tasks = tasks.filter(t => t.completed);
            } else if (historyFilter === 'pending') {
                tasks = tasks.filter(t => !t.completed);
            }

            if (tasks.length === 0) {
                content.innerHTML = `
                    <div class="history-empty">
                        <div class="history-empty-icon"></div>
                        <p>${historyFilter === 'all' ? 'No tasks yet' : 'No ' + historyFilter + ' tasks'}</p>
                    </div>
                `;
                return;
            }

            // Group by date
            const grouped = {};
            tasks.forEach(task => {
                const rawDate = task.date_entered || task.created_at || '';
                const date = typeof rawDate === 'string'
                    ? rawDate.split('T')[0].split(' ')[0]
                    : '';
                if (!grouped[date]) grouped[date] = [];
                grouped[date].push(task);
            });

            // Sort dates descending
            const sortedDates = Object.keys(grouped).sort((a, b) => new Date(b) - new Date(a));

            let html = '';
            sortedDates.forEach(date => {
                const dateObj = new Date(date + 'T00:00:00');
                const todayStr = new Date().toISOString().split('T')[0];
                const yesterdayDate = new Date();
                yesterdayDate.setDate(yesterdayDate.getDate() - 1);
                const yesterdayStr = yesterdayDate.toISOString().split('T')[0];

                let dateLabel;
                if (!date || Number.isNaN(dateObj.getTime())) {
                    dateLabel = 'Unknown date';
                } else if (date === todayStr) {
                    const readable = dateObj.toLocaleDateString('en-US', {
                        month: 'short',
                        day: 'numeric',
                        year: 'numeric'
                    });
                    dateLabel = `Today  ${readable}`;
                } else if (date === yesterdayStr) {
                    const readable = dateObj.toLocaleDateString('en-US', {
                        month: 'short',
                        day: 'numeric',
                        year: 'numeric'
                    });
                    dateLabel = `Yesterday  ${readable}`;
                } else {
                    dateLabel = dateObj.toLocaleDateString('en-US', {
                        weekday: 'long',
                        month: 'short',
                        day: 'numeric',
                        year: 'numeric'
                    });
                }

                html += `<div class="history-date-group">`;
                html += `<div class="history-date">${dateLabel}</div>`;

                grouped[date].forEach(task => {
                    const completedClass = task.completed ? 'is-completed' : '';
                    const statusClass = task.completed ? 'completed' : 'pending';
                    let meta = '';
                    if (task.completed && task.completed_at) {
                        const completedTime = new Date(task.completed_at).toLocaleTimeString('en-US', {
                            hour: 'numeric',
                            minute: '2-digit'
                        });
                        meta = `Completed at ${completedTime}`;
                    }

                    const deleteButton = task.id
                        ? `<button class="history-task-delete" onclick="deleteHistoryTask(${task.id})">Delete</button>`
                        : '';

                    html += `
                        <div class="history-task ${completedClass}">
                            <div class="history-task-status ${statusClass}"></div>
                            <div class="history-task-text">
                                ${escapeHtml(task.text)}
                                ${meta ? `<div class="history-task-meta">${meta}</div>` : ''}
                            </div>
                            ${deleteButton}
                        </div>
                    `;
                });

                html += `</div>`;
            });

            if (historyHasMore) {
                html += `
                    <button class="history-load-more" onclick="loadMoreHistory()">
                        Load older tasks
                    </button>
                `;
            }

            content.innerHTML = html;
        }

        // Save task to database
        async function saveTaskToDb(text, completed = false) {
            try {
                const res = await fetch('/api/tasks', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        text: text,
                        completed: completed,
                        date_entered: new Date().toISOString().split('T')[0]
                    })
                });
                return await res.json();
            } catch (error) {
                console.error('Failed to save task:', error);
                return null;
            }
        }

        // Update task in database
        async function updateTaskInDb(id, completed) {
            try {
                await fetch(`/api/task?id=${id}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ completed: completed })
                });
            } catch (error) {
                console.error('Failed to update task:', error);
            }
        }

        async function deleteHistoryTask(id) {
            if (!confirm('Delete this task from history?')) return;
            try {
                await fetch(`/api/task?id=${id}`, { method: 'DELETE' });
                allTasks = allTasks.filter(task => task.id !== id);
                updateHistoryStats();
                renderTaskHistory();
            } catch (error) {
                console.error('Failed to delete task:', error);
            }
        }

        // Close history with Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                const historyPanel = document.getElementById('historyPanel');
                if (historyPanel.classList.contains('active')) {
                    closeHistory();
                }
            }
        });

        // Fathom Call History
        function truncateText(text, maxLength = 180) {
            if (!text) return '';
            if (text.length <= maxLength) return text;
            return text.slice(0, maxLength).trim() + '';
        }

        async function loadCallsForCurrentProspect() {
            if (!currentModalProspectId) return;
            const loadCallsBtn = document.getElementById('loadCallsBtn');
            const callsList = document.getElementById('callsList');
            if (loadCallsBtn) {
                loadCallsBtn.disabled = true;
                loadCallsBtn.textContent = 'Loading...';
            }
            callsList.innerHTML = '<div class="calls-empty">Loading call history</div>';
            await loadProspectCalls(currentModalProspectId);
            if (loadCallsBtn) {
                loadCallsBtn.textContent = 'Reload call history';
                loadCallsBtn.disabled = false;
            }
        }

        async function loadProspectCalls(prospectId) {
            const callsSection = document.getElementById('callsSection');
            const callsList = document.getElementById('callsList');

            if (!prospectId) {
                callsSection.style.display = 'none';
                return;
            }

            try {
                const res = await fetch(`/api/fathom-calls?prospect_id=${prospectId}`);
                if (!res.ok) {
                    callsSection.style.display = 'none';
                    return;
                }

                const calls = await res.json();

                if (!calls || calls.length === 0) {
                    callsSection.style.display = 'block';
                    callsList.innerHTML = '<div class="calls-empty">No calls recorded for this contact</div>';
                    return;
                }

                callsSection.style.display = 'block';
                callsList.innerHTML = calls.map(call => {
                    const callDate = call.call_date ? new Date(call.call_date).toLocaleDateString() : '';
                    const llmItems = Array.isArray(call.action_items_llm) ? call.action_items_llm : [];
                    const actionItems = llmItems.length > 0 ? llmItems.slice(0, 3) : (call.fathom_action_items || []).slice(0, 3);

                    let actionItemsHtml = '';
                    if (actionItems.length > 0) {
                        actionItemsHtml = `
                            <div class="call-action-items">
                                <div class="call-action-items-title">Top action items</div>
                                ${actionItems.map(item => {
                                    const description = typeof item === 'string' ? item : item.description;
                                    if (!description) return '';
                                    return `
                                    <div class="call-action-item">
                                        <span class="call-action-item-text">${escapeHtml(description)}</span>
                                        ${typeof item === 'string' ? '' : (item.task_id ?
                                            '<button class="add-to-tasks-btn added">Added</button>' :
                                            `<button class="add-to-tasks-btn" onclick="addCallActionToTasks(${item.id}, '${escapeHtml(description).replace(/'/g, "\\'")}')">+ Tasks</button>`
                                        )}
                                    </div>
                                `}).join('')}
                            </div>
                        `;
                    }

                    const summaryText = call.summary_llm || call.summary ||
                        (call.raw_data && (call.raw_data.default_summary || call.raw_data.summary || call.raw_data.meeting_title)) ||
                        '';
                    const callLink = call.raw_data && (call.raw_data.share_url || call.raw_data.url);

                    return `
                        <div class="call-item">
                            <div class="call-date">${callDate}</div>
                            <div class="call-title">${escapeHtml(call.title)}</div>
                            ${summaryText ? `<div class="call-summary">${escapeHtml(truncateText(summaryText))}</div>` : ''}
                            ${callLink ? `<a class="call-link" href="${escapeHtml(callLink)}" target="_blank" rel="noopener">Open in Fathom</a>` : ''}
                            ${actionItemsHtml}
                        </div>
                    `;
                }).join('');

            } catch (error) {
                console.error('Failed to load calls:', error);
                callsSection.style.display = 'none';
            }
        }

        async function addCallActionToTasks(actionItemId, description) {
            const tasks = getCurrentTasks();
            if (tasks.length >= MAX_TASKS) {
                alert('Daily tasks full (max 3). Complete or remove a task first.');
                return;
            }

            // Add to daily tasks
            const saved = await saveTaskToDb(description, false);
            if (saved && saved.id) {
                // Update action item to link to task
                try {
                    await fetch(`/api/fathom-action-item?id=${actionItemId}`, {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ task_id: saved.id })
                    });
                } catch (e) {
                    console.error('Failed to link action item:', e);
                }

                // Add to local state
                tasks.push({ text: description, completed: false, dbId: saved.id });
                setCurrentTasks(tasks);
                saveDailyTasks();
                renderDailyTasks();

                // Refresh calls list
                const prospectId = document.getElementById('prospectId').value;
                if (prospectId) {
                    loadProspectCalls(prospectId);
                }
            }
        }

        // Unmatched Calls
        async function checkUnmatchedCalls() {
            if (SPEED_MODE) {
                const btn = document.getElementById('unmatchedCallsBtn');
                if (btn) btn.classList.remove('visible');
                return;
            }
            try {
                const res = await fetch('/api/fathom-calls?unmatched=true&limit=100');
                if (!res.ok) return;

                const calls = await res.json();
                const count = calls.length;

                const btn = document.getElementById('unmatchedCallsBtn');
                const countEl = document.getElementById('unmatchedCount');

                if (count > 0) {
                    btn.classList.add('visible');
                    countEl.textContent = count;
                } else {
                    btn.classList.remove('visible');
                }
            } catch (error) {
                console.error('Failed to check unmatched calls:', error);
            }
        }

        function showUnmatchedCalls() {
            openUnmatchedCalls();
        }

        function openUnmatchedCalls() {
            document.getElementById('unmatchedOverlay').classList.add('active');
            document.getElementById('unmatchedModal').classList.add('active');
            loadUnmatchedCalls();
        }

        function closeUnmatchedCalls() {
            document.getElementById('unmatchedOverlay').classList.remove('active');
            document.getElementById('unmatchedModal').classList.remove('active');
        }

        function deriveNameFromEmail(email) {
            if (!email) return '';
            const local = email.split('@')[0].split('+')[0]
                .replace(/[^a-zA-Z._-]/g, ' ')
                .replace(/[._-]+/g, ' ')
                .replace(/\s+/g, ' ')
                .trim();
            if (!local) return '';
            return local.split(' ').map(part => part ? part[0].toUpperCase() + part.slice(1).toLowerCase() : '').join(' ');
        }

        function guessParticipant(call) {
            const recordedBy = call.raw_data && call.raw_data.recorded_by ? call.raw_data.recorded_by.email : '';
            const invitees = (call.raw_data && call.raw_data.calendar_invitees) || [];
            for (const invitee of invitees) {
                if (!invitee || !invitee.email) continue;
                if (recordedBy && invitee.email.toLowerCase() === recordedBy.toLowerCase()) continue;
                return {
                    name: invitee.name || invitee.full_name || invitee.display_name || deriveNameFromEmail(invitee.email),
                    email: invitee.email
                };
            }
            return {
                name: deriveNameFromEmail(''),
                email: ''
            };
        }

        async function loadUnmatchedCalls() {
            const list = document.getElementById('unmatchedList');
            list.innerHTML = '<div class="calls-empty">Loading unmatched calls...</div>';

            try {
                const res = await fetch('/api/fathom-calls?unmatched=true&limit=100');
                if (!res.ok) {
                    list.innerHTML = '<div class="calls-empty">Failed to load unmatched calls</div>';
                    return;
                }
                const calls = await res.json();
                if (!calls || calls.length === 0) {
                    list.innerHTML = '<div class="calls-empty">No unmatched calls </div>';
                    return;
                }

                list.innerHTML = calls.map(call => {
                    const callDate = call.call_date ? new Date(call.call_date).toLocaleDateString() : '';
                    const summaryText = call.summary ||
                        (call.raw_data && (call.raw_data.default_summary || call.raw_data.summary || call.raw_data.meeting_title)) ||
                        '';
                    const callLink = call.raw_data && (call.raw_data.share_url || call.raw_data.url);
                    const suggestion = guessParticipant(call);

                    return `
                        <div class="unmatched-call-item" id="unmatched-call-${call.id}">
                            <div class="unmatched-call-meta">
                                <div class="unmatched-call-title">${escapeHtml(call.title)}</div>
                                <div class="unmatched-call-date">${callDate}</div>
                            </div>
                            ${summaryText ? `<div class="unmatched-call-summary">${escapeHtml(truncateText(summaryText, 200))}</div>` : ''}
                            ${callLink ? `<a class="call-link" href="${escapeHtml(callLink)}" target="_blank" rel="noopener">Open in Fathom</a>` : ''}
                            <div class="unmatched-call-actions">
                                <input class="unmatched-input" name="name" placeholder="Prospect name" value="${escapeHtml(suggestion.name || '')}">
                                <input class="unmatched-input" name="email" placeholder="Email" value="${escapeHtml(suggestion.email || '')}">
                                <button class="unmatched-action-btn" onclick="createProspectForCall(${call.id})">Create & Link</button>
                                <button class="unmatched-action-btn danger" onclick="deleteUnmatchedCall(${call.id})">Delete Call</button>
                            </div>
                        </div>
                    `;
                }).join('');

            } catch (error) {
                console.error('Failed to load unmatched calls:', error);
                list.innerHTML = '<div class="calls-empty">Failed to load unmatched calls</div>';
            }
        }

        async function createProspectForCall(callId) {
            const container = document.getElementById(`unmatched-call-${callId}`);
            if (!container) return;

            const nameInput = container.querySelector('input[name="name"]');
            const emailInput = container.querySelector('input[name="email"]');
            const name = nameInput ? nameInput.value.trim() : '';
            const email = emailInput ? emailInput.value.trim() : '';

            if (!name && !email) {
                alert('Please provide a name or email.');
                return;
            }

            try {
                const res = await fetch('/api/prospects', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: name || deriveNameFromEmail(email) || email,
                        email: email || null,
                        status: 'contacted',
                        notes: 'Created from unmatched Fathom call.'
                    })
                });

                if (!res.ok) {
                    alert('Failed to create prospect.');
                    return;
                }

                const prospect = await res.json();
                if (!prospect || !prospect.id) {
                    alert('Prospect created, but no ID returned.');
                    return;
                }

                await fetch(`/api/fathom-call?id=${callId}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prospect_id: prospect.id })
                });

                container.remove();
                checkUnmatchedCalls();
            } catch (error) {
                console.error('Failed to create prospect:', error);
                alert('Failed to create prospect.');
            }
        }

        async function deleteUnmatchedCall(callId) {
            if (!confirm('Delete this call? This cannot be undone.')) return;
            try {
                const res = await fetch(`/api/fathom-call?id=${callId}`, { method: 'DELETE' });
                if (!res.ok) {
                    alert('Failed to delete call.');
                    return;
                }
                const container = document.getElementById(`unmatched-call-${callId}`);
                if (container) container.remove();
                checkUnmatchedCalls();
            } catch (error) {
                console.error('Failed to delete call:', error);
                alert('Failed to delete call.');
            }
        }

        // Check for unmatched calls on page load
        checkUnmatchedCalls();
    </script>

    <!-- Celebration Overlay -->
    <div class="celebration" id="celebration">
        <div class="celebration-content">
            <div class="celebration-emoji"></div>
            <div class="celebration-title">YOU CRUSHED IT!</div>
            <div class="celebration-subtitle">All tasks complete. You're unstoppable.</div>
            <button class="celebration-btn" onclick="closeCelebration()">Keep Going</button>
        </div>
    </div>

    <!-- History Panel -->
    <div class="history-overlay" id="historyOverlay" onclick="closeHistory()"></div>
    <div class="history-panel" id="historyPanel">
        <div class="history-header">
            <h2 class="history-title">Task History</h2>
            <button class="history-close" onclick="closeHistory()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"/>
                    <line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
            </button>
        </div>
        <div class="history-filters">
            <button class="history-filter active" data-filter="all" onclick="setHistoryFilter('all')">All Tasks</button>
            <button class="history-filter completed" data-filter="completed" onclick="setHistoryFilter('completed')">Completed</button>
            <button class="history-filter" data-filter="pending" onclick="setHistoryFilter('pending')">Pending</button>
        </div>
        <div class="history-stats" id="historyStats">
            <div class="history-stat">
                <div class="history-stat-value green" id="historyCompleted">0</div>
                <div class="history-stat-label">Completed</div>
            </div>
            <div class="history-stat">
                <div class="history-stat-value blue" id="historyTotal">0</div>
                <div class="history-stat-label">Total</div>
            </div>
            <div class="history-stat">
                <div class="history-stat-value yellow" id="historyRate">0%</div>
                <div class="history-stat-label">Completion</div>
            </div>
        </div>
        <div class="history-content" id="historyContent">
            <div class="history-loading">Loading tasks...</div>
        </div>
    </div>
</body>
</html>
